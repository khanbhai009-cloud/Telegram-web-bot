<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>CoinEarn Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <style>
        /* Custom Styles for Mini App, Glassmorphism, and Responsiveness */
        body {
            /* Ensures full-screen mobile experience within Telegram */
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 70px; /* Space for the bottom navigation */
        }

        /* Glassmorphism Card Style */
        .glass-card {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        /* Modern Gradient Background */
        .app-container {
            flex-grow: 1;
            background: linear-gradient(135deg, var(--tg-theme-button-color, #2481cc), var(--tg-theme-secondary-bg-color, #17212b));
        }

        /* Bottom Navigation Bar */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--tg-theme-secondary-bg-color, #17212b);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .bottom-nav button {
            transition: all 0.2s ease;
            color: var(--tg-theme-hint-color, #708499);
        }

        .bottom-nav button.active {
            color: var(--tg-theme-button-color, #2481cc);
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Page transitions */
        .page {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            padding: 1rem;
            min-height: 100%;
        }

        .page.active {
            display: block;
            opacity: 1;
        }

        /* Custom Scrollbar for better UX */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--tg-theme-button-color, #2481cc);
            border-radius: 2px;
        }
        ::-webkit-scrollbar-track {
            background: var(--tg-theme-secondary-bg-color, #17212b);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

    <header id="top-bar" class="sticky top-0 p-4 shadow-lg flex justify-between items-center z-50"
            style="background-color: var(--tg-theme-secondary-bg-color, #17212b);">
        <h1 id="app-title" class="text-xl font-bold">Loading...</h1>
        <div id="user-balance-display" class="hidden flex items-center bg-green-500 rounded-full px-3 py-1 text-sm font-semibold shadow-md">
            <span class="mr-1">üí∞</span>
            <span id="user-balance">0</span>
        </div>
    </header>

    <main id="app-content" class="app-container p-4 flex-grow overflow-y-auto">
        <div id="user-home-page" class="page active">
            <h2 class="text-2xl font-bold mb-4">Dashboard üöÄ</h2>
            <div id="user-dashboard-cards" class="grid grid-cols-2 gap-4 mb-6">
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-green-400" id="total-earn">0</div>
                    <div class="text-sm mt-1 text-gray-300">Total Earn (üí∞)</div>
                </div>
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-red-400" id="total-withdrawal">0</div>
                    <div class="text-sm mt-1 text-gray-300">Total Withdrawal (üè¶)</div>
                </div>
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-yellow-400" id="ads-watched">0</div>
                    <div class="text-sm mt-1 text-gray-300">Ads Watched (üì∫)</div>
                </div>
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-blue-400" id="total-tasks-done">0</div>
                    <div class="text-sm mt-1 text-gray-300">Tasks Done (‚úÖ)</div>
                </div>
            </div>

            <h3 class="text-xl font-semibold mb-3">Quick Actions</h3>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="navigateTo('watch-ads-page')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                    üì∫ Watch Ads
                </button>
                <button onclick="navigateTo('tasks-page')" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                    ‚úÖ Tasks
                </button>
                <button onclick="navigateTo('withdraw-page')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                    üè¶ Withdraw
                </button>
                <button onclick="navigateTo('profile-page')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                    üë§ Profile
                </button>
            </div>
        </div>

        <div id="watch-ads-page" class="page">
            <h2 class="text-2xl font-bold mb-4">Watch Ads for Coins</h2>
            <div class="glass-card text-center">
                <p class="text-lg mb-4">Earn **10 Coins** for every ad watched!</p>
                <button id="watch-ad-btn" onclick="startAdSequence()" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-6 rounded-full shadow-xl transition-all duration-300 transform hover:scale-105">
                    ‚ñ∂Ô∏è Watch Ad Now
                </button>
                <div id="monotag-ad-placeholder" class="mt-6 p-4 border border-dashed border-gray-500 rounded-lg text-sm text-gray-400 h-24 flex items-center justify-center">
                    [Monotag Ads Code Placeholder]
                </div>
            </div>
        </div>

        <div id="tasks-page" class="page">
            <h2 class="text-2xl font-bold mb-4">Daily Tasks</h2>
            <div id="tasks-list" class="space-y-4">
                </div>
            <p id="no-tasks-msg" class="text-gray-400 mt-4 hidden">No tasks available right now. Check back later!</p>
        </div>

        <div id="withdraw-page" class="page">
            <h2 class="text-2xl font-bold mb-4">Withdrawal Request</h2>
            <div class="glass-card">
                <div class="mb-4">
                    <label for="withdraw-amount" class="block mb-2 font-semibold">Amount (Coins)</label>
                    <input type="number" id="withdraw-amount" placeholder="Min 1000 Coins" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="upi-id" class="block mb-2 font-semibold">UPI ID</label>
                    <input type="text" id="upi-id" placeholder="yourname@bankupi" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button id="request-withdraw-btn" onclick="requestWithdrawal()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition-all duration-200">
                    üí∏ Request Withdrawal
                </button>
            </div>

            <h3 class="text-xl font-bold mt-8 mb-4">Withdrawal History</h3>
            <div id="withdrawal-history-list" class="space-y-3">
                <p class="text-gray-400 text-sm">Loading history...</p>
            </div>
        </div>

        <div id="profile-page" class="page">
            <h2 class="text-2xl font-bold mb-4">Your Profile</h2>
            <div id="profile-details" class="space-y-3 glass-card">
                </div>

            <h3 class="text-xl font-bold mt-8 mb-4">Refer & Earn (500 Coins!)</h3>
            <div class="glass-card p-4">
                <p class="mb-3">Share your unique link to invite friends. You both get **500 Coins**!</p>
                <input type="text" id="referral-link" readonly class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-sm mb-3">
                <button onclick="copyReferralLink()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-xl transition-all duration-200">
                    üîó Copy Link
                </button>
            </div>

            <h3 class="text-xl font-bold mt-8 mb-4">Referral History</h3>
            <div id="referral-history-list" class="space-y-3">
                <p class="text-gray-400 text-sm">Loading referrals...</p>
            </div>
        </div>

        <div id="admin-dashboard-page" class="page active">
            <h2 class="text-2xl font-bold mb-4">Admin Dashboard üëë</h2>
            <div id="admin-dashboard-cards" class="grid grid-cols-2 gap-4 mb-6">
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-green-400" id="total-users-admin">0</div>
                    <div class="text-sm mt-1 text-gray-300">Total Users</div>
                </div>
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-red-400" id="total-tasks-admin">0</div>
                    <div class="text-sm mt-1 text-gray-300">Total Tasks</div>
                </div>
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-yellow-400" id="total-withdrawals-admin">0</div>
                    <div class="text-sm mt-1 text-gray-300">Total Withdrawals</div>
                </div>
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-blue-400" id="total-ads-admin">0</div>
                    <div class="text-sm mt-1 text-gray-300">Total Ads Watched</div>
                </div>
            </div>

            <h3 class="text-xl font-semibold mb-3">Admin Quick Tools</h3>
            <div class="space-y-4">
                <button onclick="navigateTo('admin-task-management-page')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                    ‚ûï Manage Tasks
                </button>
                <button onclick="navigateTo('admin-withdrawal-management-page')" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                    üè¶ Manage Withdrawals
                </button>
                <button onclick="navigateTo('admin-tools-page')" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                    ‚öôÔ∏è Admin Tools
                </button>
            </div>
        </div>

        <div id="admin-task-management-page" class="page">
            <h2 class="text-2xl font-bold mb-4">Task Management</h2>

            <div class="glass-card mb-6 p-4">
                <h3 class="text-xl font-semibold mb-3">‚ûï Add New Task</h3>
                <input type="text" id="task-title" placeholder="Title" class="w-full p-3 mb-3 bg-gray-800 border border-gray-700 rounded-lg">
                <textarea id="task-description" placeholder="Description" rows="2" class="w-full p-3 mb-3 bg-gray-800 border border-gray-700 rounded-lg"></textarea>
                <input type="number" id="task-reward" placeholder="Reward (Coins)" class="w-full p-3 mb-3 bg-gray-800 border border-gray-700 rounded-lg">
                <input type="url" id="task-link" placeholder="Visit Link (e.g., https://example.com)" class="w-full p-3 mb-4 bg-gray-800 border border-gray-700 rounded-lg">
                <button onclick="addNewTask()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-xl transition-all duration-200">
                    Publish Task
                </button>
            </div>

            <h3 class="text-xl font-bold mb-4">Current Tasks</h3>
            <div id="admin-tasks-list" class="space-y-4">
                </div>
        </div>

        <div id="admin-withdrawal-management-page" class="page">
            <h2 class="text-2xl font-bold mb-4">Withdrawal Requests</h2>
            <div id="withdrawal-requests-list" class="space-y-4">
                <p class="text-gray-400 text-sm">Loading requests...</p>
            </div>
        </div>

        <div id="admin-tools-page" class="page">
            <h2 class="text-2xl font-bold mb-4">Admin Tools</h2>

            <div class="glass-card mb-6 p-4">
                <h3 class="text-xl font-semibold mb-3">Manual Balance Adjust</h3>
                <input type="number" id="manual-user-id" placeholder="User Telegram ID" class="w-full p-3 mb-3 bg-gray-800 border border-gray-700 rounded-lg">
                <input type="number" id="manual-amount" placeholder="Amount to Add/Subtract (+/-)" class="w-full p-3 mb-3 bg-gray-800 border border-gray-700 rounded-lg">
                <button onclick="adjustUserBalance()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-xl transition-all duration-200">
                    Apply Adjustment
                </button>
            </div>

            <div class="glass-card p-4">
                <h3 class="text-xl font-semibold mb-3">Broadcast Message</h3>
                <textarea id="broadcast-message" placeholder="Message to send to all users (Optional)" rows="3" class="w-full p-3 mb-3 bg-gray-800 border border-gray-700 rounded-lg"></textarea>
                <button onclick="sendBroadcast()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-xl transition-all duration-200">
                    Send Broadcast
                </button>
                <p class="text-xs text-gray-400 mt-2">Note: This is a placeholder function; actual Telegram message broadcast requires a separate bot API server.</p>
            </div>
        </div>

        <div id="system-popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[200] hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center" style="color: var(--tg-theme-text-color, #000);">
                <h3 id="popup-title" class="text-xl font-bold mb-3">Notification</h3>
                <p id="popup-message" class="mb-4">Message content.</p>
                <button onclick="hidePopup()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200">
                    OK
                </button>
            </div>
        </div>

    </main>

    <footer id="bottom-nav" class="bottom-nav flex justify-around items-center px-2">
        </footer>

    <script>
        // === 1. CONFIGURATION & INITIALIZATION ===

        // TODO: Replace with your actual Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        const urlParams = new URLSearchParams(window.location.search);
        const isUserMode = urlParams.get('user') === 'true';
        const isAdminMode = urlParams.get('admin') === 'true';
        let currentUser = null;
        let telegramUser = window.Telegram.WebApp.initDataUnsafe.user || {
            id: 123456789, // Placeholder for testing outside Telegram
            first_name: "Test",
            username: "tester"
        };
        const REFERRAL_REWARD = 500; // Coins per referral

        // === 2. UI UTILITY FUNCTIONS ===

        /**
         * Shows a notification popup to the user.
         * @param {string} title
         * @param {string} message
         */
        function showPopup(title, message) {
            document.getElementById('popup-title').innerText = title;
            document.getElementById('popup-message').innerText = message;
            document.getElementById('system-popup').classList.remove('hidden');
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

        function hidePopup() {
            document.getElementById('system-popup').classList.add('hidden');
        }

        /**
         * Handles page navigation and transition.
         * @param {string} pageId The ID of the page to navigate to (e.g., 'user-home-page').
         */
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            // Update active state on bottom navigation
            document.querySelectorAll('.bottom-nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            const navButton = document.querySelector(`[onclick*="${pageId}"]`);
            if (navButton) {
                navButton.classList.add('active');
            }

            // Update app title
            const titleMap = {
                'user-home-page': 'Dashboard',
                'watch-ads-page': 'Watch Ads',
                'tasks-page': 'Tasks',
                'withdraw-page': 'Withdraw',
                'profile-page': 'Profile',
                'admin-dashboard-page': 'Admin Dashboard',
                'admin-task-management-page': 'Manage Tasks',
                'admin-withdrawal-management-page': 'Manage Withdrawals',
                'admin-tools-page': 'Admin Tools'
            };
            document.getElementById('app-title').innerText = titleMap[pageId] || 'CoinEarn App';

            // Show balance only in user mode
            document.getElementById('user-balance-display').classList.toggle('hidden', !isUserMode);
        }

        /**
         * Builds the bottom navigation bar based on the mode.
         */
        function setupBottomNav() {
            const nav = document.getElementById('bottom-nav');
            nav.innerHTML = ''; // Clear existing buttons

            if (isUserMode) {
                const userNavItems = [
       