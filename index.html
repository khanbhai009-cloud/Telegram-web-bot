<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>User Panel | Mini Web Bot</title>

  <!-- Firebase (compat) SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#f5f8ff;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2563eb;
      --success:#16a34a;
      --danger:#ef4444;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{margin:0;background:var(--bg);color:#0f172a; -webkit-font-smoothing:antialiased;}
    .wrap{max-width:920px;margin:16px auto;padding:12px;}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px;}
    .avatar{width:64px;height:64px;border-radius:12px;object-fit:cover;background:#eee;}
    .userinfo h1{font-size:18px;margin:0 0 4px 0;}
    .userinfo p{margin:0;color:var(--muted);font-size:13px;}
    .banner{background:#fff3cd;border-left:4px solid #ffd027;padding:10px;border-radius:10px;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:12px;}
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04);min-height:72px;}
    .card .label{color:var(--muted);font-size:12px;}
    .card .value{font-size:18px;font-weight:700;margin-top:6px;}
    .ref-link{display:flex;gap:8px;align-items:center;margin-top:8px;font-size:13px;color:var(--muted);word-break:break-all;}
    .tabs{display:flex;gap:8px;margin:12px 0;}
    .tab{padding:8px 12px;border-radius:10px;background:transparent;border:1px solid transparent;color:var(--muted);cursor:pointer;}
    .tab.active{background:var(--card);border-color:rgba(15,23,42,0.06);color:var(--accent);font-weight:600;}
    .section{margin-bottom:14px;}
    .task-list{display:grid;gap:8px;}
    .task{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:var(--card);box-shadow:0 6px 12px rgba(15,23,42,0.03);}
    .task .meta{max-width:62%;}
    .task .meta h4{margin:0 0 6px 0;font-size:15px;}
    .task .meta p{margin:0;color:var(--muted);font-size:13px;}
    .btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer;font-weight:600;}
    .btn-primary{background:var(--accent);color:white;}
    .btn-ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);color:var(--muted);}
    .btn-success{background:var(--success);color:white;}
    .small{font-size:13px;padding:6px 8px;border-radius:8px;}
    .muted{color:var(--muted);font-size:13px;}
    .controls{display:flex;gap:8px;align-items:center;}
    .input{padding:8px;border-radius:8px;border:1px solid #e6edf3;background:white;width:100%;}
    .row{display:flex;gap:8px;}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:white;padding:10px 14px;border-radius:8px;display:none;}
    @media(max-width:520px){
      header{align-items:flex-start;}
      .avatar{width:56px;height:56px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img id="userPic" class="avatar" src="" alt="avatar" />
      <div class="userinfo">
        <h1 id="userName">Guest</h1>
        <p id="userId">ID: --</p>
        <div class="ref-link" style="margin-top:6px">
          <span class="muted">Referral:</span>
          <span id="refLink" style="font-weight:600;color:var(--accent);margin-left:6px">--</span>
          <button id="copyRef" class="btn btn-ghost small" style="margin-left:auto">Copy</button>
        </div>
      </div>
    </header>

    <!-- Announcement banner -->
    <div id="announcement" class="banner" style="display:none">
      <div id="announcementText" style="font-weight:600;color:#7a5800"></div>
      <button id="dismissAnn" class="btn btn-ghost small" style="margin-left:auto">Dismiss</button>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div id="tabDashboard" class="tab active">Dashboard</div>
      <div id="tabTasks" class="tab">Tasks</div>
    </div>

    <!-- Dashboard content -->
    <div id="dashboardView">
      <div class="cards section" id="statsCards">
        <div class="card">
          <div class="label">Total ₹</div>
          <div id="totalCoins" class="value">₹0</div>
        </div>
        <div class="card">
          <div class="label">Total Referrals</div>
          <div id="totalRef" class="value">0</div>
        </div>
        <div class="card">
          <div class="label">Total Withdrawn</div>
          <div id="totalWithdrawn" class="value">₹0</div>
        </div>
        <div class="card">
          <div class="label">Tasks Completed</div>
          <div id="tasksCompleted" class="value">0</div>
        </div>
      </div>

      <div class="section card">
        <h3 style="margin:0 0 8px 0">Quick Actions</h3>
        <div id="quickTasks" class="task-list">
          <div class="muted">Loading tasks…</div>
        </div>
      </div>

      <div class="section card">
        <h3 style="margin:0 0 8px 0">Withdrawal</h3>
        <div style="margin-bottom:8px" class="muted">Request withdrawal via UPI (admin will approve).</div>
        <div class="row" style="margin-bottom:8px">
          <input id="upi" class="input" placeholder="Enter UPI ID (eg: name@bank)" />
          <input id="amount" class="input" placeholder="Amount (₹)" type="number" />
        </div>
        <div style="display:flex;gap:8px">
          <button id="withdrawBtn" class="btn btn-primary">Request Withdrawal</button>
        </div>

        <div style="margin-top:12px">
          <h4 style="margin:0 0 8px 0">Recent Withdrawals</h4>
          <div id="recentWithdrawals" class="muted">No requests yet.</div>
        </div>
      </div>
    </div>

    <!-- Tasks tab content -->
    <div id="tasksView" style="display:none">
      <div class="section card">
        <h3 style="margin:0 0 8px 0">All Tasks</h3>
        <div style="margin-bottom:8px">
          <input id="searchTask" class="input" placeholder="Search tasks by name or type" />
        </div>
        <div id="allTasks" class="task-list">
          <div class="muted">Loading tasks…</div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Script -->
  <script>
  /***** ====== CONFIG PLACEHOLDERS ======
   * Replace firebaseConfig below with your Firebase credentials.
   * Replace BOT_USERNAME with your bot username (no @).
   *****************************************/
  const firebaseConfig = {
  apiKey: "AIzaSyD-EiTLr-bDDDKgR5tvzguyNfdlKDO8Rw8",
  authDomain: "tap-and-earn-d3583.firebaseapp.com",
  projectId: "tap-and-earn-d3583",
  storageBucket: "tap-and-earn-d3583.firebasestorage.app",
  messagingSenderId: "759083332180",
  appId: "1:759083332180:web:165eb0bf070956fb0033c1"
};
  const BOT_USERNAME = "earn_with_finisher_bot"; // e.g. "my_bot"

  /***** ====== INIT FIREBASE (compat) ====== *****/
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const FieldValue = firebase.firestore.FieldValue;

  /***** ====== TELEGRAM WEBAPP INIT ====== *****/
  const tg = window.Telegram?.WebApp;
  try { if (tg) tg.expand(); } catch(e){/* ignore */ }

  // Get user info: try Telegram WebApp context, fallback to URL params or guest
  const urlParams = new URLSearchParams(location.search);
  const startParam = urlParams.get("start") || (tg?.initDataUnsafe?.start_param) || null;

  const tgUser = (tg?.initDataUnsafe?.user) ? tg.initDataUnsafe.user : null;
  const user = {
    id: tgUser?.id || urlParams.get("userId") || ("guest_" + Math.floor(Math.random()*10000)),
    name: tgUser?.first_name || tgUser?.username || "Guest",
    photoURL: tgUser?.photo_url || ""
  };

  // DOM refs
  const userPic = document.getElementById("userPic");
  const userName = document.getElementById("userName");
  const userIdEl = document.getElementById("userId");
  const refLinkEl = document.getElementById("refLink");
  const copyRefBtn = document.getElementById("copyRef");

  const announcementEl = document.getElementById("announcement");
  const announcementText = document.getElementById("announcementText");
  const dismissAnn = document.getElementById("dismissAnn");

  const totalCoinsEl = document.getElementById("totalCoins");
  const totalRefEl = document.getElementById("totalRef");
  const totalWithdrawnEl = document.getElementById("totalWithdrawn");
  const tasksCompletedEl = document.getElementById("tasksCompleted");

  const quickTasksEl = document.getElementById("quickTasks");
  const allTasksEl = document.getElementById("allTasks");
  const recentWithdrawalsEl = document.getElementById("recentWithdrawals");

  const upiInput = document.getElementById("upi");
  const amountInput = document.getElementById("amount");
  const withdrawBtn = document.getElementById("withdrawBtn");

  const tabDashboard = document.getElementById("tabDashboard");
  const tabTasks = document.getElementById("tabTasks");
  const dashboardView = document.getElementById("dashboardView");
  const tasksView = document.getElementById("tasksView");
  const searchTask = document.getElementById("searchTask");

  const toastEl = document.getElementById("toast");

  /***** ====== UTIL ====== *****/
  function showToast(msg, timeout=3000){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    setTimeout(()=>toastEl.style.display = "none", timeout);
  }

  function formatRupee(n){ return "₹" + (Number(n)||0); }

  function referralLinkFor(id){ return `https://t.me/${BOT_USERNAME}?start=${id}`; }

  /***** ====== USER DOC REF & INIT ====== *****/
  const uid = String(user.id);
  const userRef = db.collection("users").doc(uid);

  async function createUserIfNotExists(){
    const snap = await userRef.get();
    if (!snap.exists){
      const doc = {
        id: uid,
        name: user.name,
        photoURL: user.photoURL || "",
        coins: 0,
        reffer: 0,
        refferBy: startParam || null,
        tasksCompleted: 0,
        totalWithdrawals: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await userRef.set(doc, { merge: true });
    } else {
      // if user exists but refferBy is not set and startParam exists - set it once
      if (startParam && !snap.data().refferBy){
        await userRef.set({ refferBy: startParam }, { merge: true });
      }
    }
  }

  /***** ====== RENDER BASIC INFO ====== *****/
  function renderBasic(){
    userPic.src = user.photoURL || ("https://cdn.jsdelivr.net/gh/edent/SuperTinyIcons/images/svg/telegram.svg");
    userName.textContent = user.name || "Guest";
    userIdEl.textContent = "ID: " + uid;
    refLinkEl.textContent = referralLinkFor(uid);
  }

  copyRefBtn.addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(referralLinkFor(uid));
      showToast("Referral copied!");
    }catch(e){
      showToast("Copy failed - long press the link");
    }
  });

  /***** ====== ANNOUNCEMENT (realtime) ====== *****/
  let annDismissed = false;
  dismissAnn.addEventListener("click", ()=>{
    announcementEl.style.display = "none";
    annDismissed = true;
  });

  db.collection("announcements").orderBy("createdAt","desc").limit(1)
    .onSnapshot(snap=>{
      if (snap.empty) {
        announcementEl.style.display = "none";
        return;
      }
      snap.forEach(doc=>{
        const a = doc.data();
        if (!annDismissed) {
          announcementText.textContent = a.title || (a.body||"Announcement");
          announcementEl.style.display = "flex";
        }
      });
    });

  /***** ====== USER STATS (realtime) ====== *****/
  userRef.onSnapshot(snap=>{
    if (!snap.exists) return;
    const d = snap.data();
    totalCoinsEl.textContent = formatRupee(d.coins || 0);
    totalRefEl.textContent = String(d.reffer || 0);
    totalWithdrawnEl.textContent = formatRupee(d.totalWithdrawals || 0);
    tasksCompletedEl.textContent = String(d.tasksCompleted || 0);
  });

  /***** ====== QUICK TASKS (top 3) ====== *****/
  function renderTaskCard(doc, container, isQuick=false){
    const d = doc.data();
    const id = doc.id;
    const el = document.createElement("div");
    el.className = "task";
    el.innerHTML = `
      <div class="meta">
        <h4>${escapeHtml(d.name || "Task")}</h4>
        <p>${escapeHtml(d.type || "Task type")} • ${formatRupee(d.reward || 0)}</p>
      </div>
      <div class="controls">
        <button class="btn btn-ghost small" data-link="${escapeAttr(d.link||'')}" onclick="openTask(event,'${id}')">Open</button>
        <button class="btn btn-primary small" onclick="claimTask('${id}', ${Number(d.reward||0)})">Claim</button>
      </div>`;
    container.appendChild(el);
  }

  // load top 3 quick tasks
  db.collection("tasks").orderBy("createdAt","desc").limit(3).onSnapshot(snap=>{
    quickTasksEl.innerHTML = "";
    if (snap.empty) {
      quickTasksEl.innerHTML = '<div class="muted">No tasks available.</div>';
      return;
    }
    snap.forEach(doc=>renderTaskCard(doc, quickTasksEl, true));
  });

  /***** ====== ALL TASKS (tasks tab) ====== *****/
  let tasksCache = [];
  db.collection("tasks").orderBy("createdAt","desc").onSnapshot(snap=>{
    tasksCache = [];
    allTasksEl.innerHTML = "";
    if (snap.empty) {
      allTasksEl.innerHTML = '<div class="muted">No tasks yet.</div>';
      return;
    }
    snap.forEach(doc=>{
      tasksCache.push({ id: doc.id, data: doc.data() });
      renderTaskCard(doc, allTasksEl, false);
    });
  });

  searchTask?.addEventListener("input", ()=>{
    const q = (searchTask.value || "").toLowerCase();
    allTasksEl.innerHTML = "";
    const filtered = tasksCache.filter(t => (t.data.name||'').toLowerCase().includes(q) || (t.data.type||'').toLowerCase().includes(q));
    if (!filtered.length) { allTasksEl.innerHTML = '<div class="muted">No tasks match.</div>'; return; }
    filtered.forEach(t => {
      const fakeDoc = { id: t.id, data: t.data };
      renderTaskCard(fakeDoc, allTasksEl, false);
    });
  });

  /***** ====== OPEN TASK ====== *****/
  function openTask(ev, taskId){
    const link = ev.currentTarget?.getAttribute('data-link') || '';
    if (link) window.open(link, "_blank");
  }
  window.openTask = openTask; // expose for inline onclick usage

  /***** ====== CLAIM TASK (transaction + user_claims) ====== *****/
  async function claimTask(taskId, reward){
    try{
      const claimId = `${uid}_${taskId}`;
      const claimRef = db.collection("user_claims").doc(claimId);
      const taskRef = db.collection("tasks").doc(taskId);
      const uRef = userRef;

      await db.runTransaction(async (t)=>{
        const claimSnap = await t.get(claimRef);
        if (claimSnap.exists) throw new Error("Already claimed");

        // optional: check user has not already claimed via other means
        // mark claim and increment counters
        t.set(claimRef, { userId: uid, taskId: taskId, claimedAt: firebase.firestore.FieldValue.serverTimestamp() });

        // increment user's coins and tasksCompleted
        t.update(uRef, {
          coins: firebase.firestore.FieldValue.increment(Number(reward||0)),
          tasksCompleted: firebase.firestore.FieldValue.increment(1)
        });
      });

      showToast(`Reward added: ₹${reward}`);
    }catch(err){
      console.error("claimTask err", err);
      if (String(err).toLowerCase().includes("already claimed")) showToast("Task already claimed");
      else showToast("Claim failed");
    }
  }
  window.claimTask = claimTask; // expose for inline onclick usage

  /***** ====== WITHDRAWALS (request + recent list) ====== *****/
  withdrawBtn.addEventListener("click", async ()=>{
    const upi = (upiInput.value || "").trim();
    const amount = Number(amountInput.value || 0);
    if (!upi || amount <= 0) return showToast("Enter valid UPI and amount");
    try{
      await db.collection("withdrawals").add({
        userId: uid,
        upi,
        amount,
        status: "pending",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      showToast("Withdrawal requested");
      upiInput.value = ""; amountInput.value = "";
    }catch(e){
      console.error("withdraw err", e);
      showToast("Request failed");
    }
  });

  // recent withdrawals (for current user)
  db.collection("withdrawals").where("userId","==",uid).orderBy("createdAt","desc").limit(3)
    .onSnapshot(snap=>{
      if (snap.empty){ recentWithdrawalsEl.innerHTML = '<div class="muted">No requests yet.</div>'; return; }
      const arr = [];
      snap.forEach(d=>{
        const dd = d.data();
        arr.push(`<div style="margin-bottom:6px">${formatRupee(dd.amount)} — ${dd.status} <div class="muted" style="font-size:12px">${dd.upi}</div></div>`);
      });
      recentWithdrawalsEl.innerHTML = arr.join("");
    });

  /***** ====== TASKS TAB SWITCHING ====== *****/
  tabDashboard.addEventListener("click", ()=>{
    tabDashboard.classList.add("active");
    tabTasks.classList.remove("active");
    dashboardView.style.display = "";
    tasksView.style.display = "none";
  });
  tabTasks.addEventListener("click", ()=>{
    tabTasks.classList.add("active");
    tabDashboard.classList.remove("active");
    dashboardView.style.display = "none";
    tasksView.style.display = "";
  });

  /***** ====== RECENT ANNOUNCEMENTS LOGIC DONE ABOVE ====== *****/

  /***** ====== ESCAPE UTIL (small) ====== *****/
  function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
  function escapeAttr(s){ return (s||"").replace(/"/g,'&quot;'); }

  /***** ====== INIT FLOW ====== *****/
  (async function init(){
    renderBasic();
    await createUserIfNotExists();

    // Render any immediate UI states already bound to listeners (listeners set above)
    // Also fetch tasks once to update tasksCache if needed (already done by onSnapshot)

    // Optionally: show welcome toast
    setTimeout(()=> showToast(`Welcome ${user.name}!`), 600);
  })();
  </script>
</body>
</html>