<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>CoinEarn Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <style>
        /* Custom Styles for Mini App, Glassmorphism, and Responsiveness */
        body {
            /* Ensures full-screen mobile experience within Telegram */
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 70px; /* Space for the bottom navigation */
        }

        /* Glassmorphism Card Style */
        .glass-card {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        /* Modern Gradient Background */
        .app-container {
            flex-grow: 1;
            background: linear-gradient(135deg, var(--tg-theme-button-color, #2481cc), var(--tg-theme-secondary-bg-color, #17212b));
        }

        /* Bottom Navigation Bar */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--tg-theme-secondary-bg-color, #17212b);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .bottom-nav button {
            transition: all 0.2s ease;
            color: var(--tg-theme-hint-color, #708499);
        }

        .bottom-nav button.active {
            color: var(--tg-theme-button-color, #2481cc);
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Page transitions */
        .page {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            padding: 1rem;
            min-height: 100%;
        }

        .page.active {
            display: block;
            opacity: 1;
        }

        /* Custom Scrollbar for better UX */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--tg-theme-button-color, #2481cc);
            border-radius: 2px;
        }
        ::-webkit-scrollbar-track {
            background: var(--tg-theme-secondary-bg-color, #17212b);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

    <header id="top-bar" class="sticky top-0 p-4 shadow-lg flex justify-between items-center z-50"
            style="background-color: var(--tg-theme-secondary-bg-color, #17212b);">
        <h1 id="app-title" class="text-xl font-bold">Loading...</h1>
        <div id="user-balance-display" class="hidden flex items-center bg-green-500 rounded-full px-3 py-1 text-sm font-semibold shadow-md">
            <span class="mr-1">üí∞</span>
            <span id="user-balance">0</span>
        </div>
    </header>

    <main id="app-content" class="app-container p-4 flex-grow overflow-y-auto">
        <div id="user-home-page" class="page active">
            <h2 class="text-2xl font-bold mb-4">Dashboard üöÄ</h2>
            <div id="user-dashboard-cards" class="grid grid-cols-2 gap-4 mb-6">
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-green-400" id="total-earn">0</div>
                    <div class="text-sm mt-1 text-gray-300">Total Earn (üí∞)</div>
                </div>
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-red-400" id="total-withdrawal">0</div>
                    <div class="text-sm mt-1 text-gray-300">Total Withdrawal (üè¶)</div>
                </div>
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-yellow-400" id="ads-watched">0</div>
                    <div class="text-sm mt-1 text-gray-300">Ads Watched (üì∫)</div>
                </div>
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-blue-400" id="total-tasks-done">0</div>
                    <div class="text-sm mt-1 text-gray-300">Tasks Done (‚úÖ)</div>
                </div>
            </div>

            <h3 class="text-xl font-semibold mb-3">Quick Actions</h3>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="navigateTo('watch-ads-page')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                    üì∫ Watch Ads
                </button>
                <button onclick="navigateTo('tasks-page')" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                    ‚úÖ Tasks
                </button>
                <button onclick="navigateTo('withdraw-page')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                    üè¶ Withdraw
                </button>
                <button onclick="navigateTo('profile-page')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                    üë§ Profile
                </button>
            </div>
        </div>

        <div id="watch-ads-page" class="page">
            <h2 class="text-2xl font-bold mb-4">Watch Ads for Coins</h2>
            <div class="glass-card text-center">
                <p class="text-lg mb-4">Earn **10 Coins** for every ad watched!</p>
                <button id="watch-ad-btn" onclick="startAdSequence()" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-6 rounded-full shadow-xl transition-all duration-300 transform hover:scale-105">
                    ‚ñ∂Ô∏è Watch Ad Now
                </button>
                <div id="monotag-ad-placeholder" class="mt-6 p-4 border border-dashed border-gray-500 rounded-lg text-sm text-gray-400 h-24 flex items-center justify-center">
                    [Monotag Ads Code Placeholder]
                </div>
            </div>
        </div>

        <div id="tasks-page" class="page">
            <h2 class="text-2xl font-bold mb-4">Daily Tasks</h2>
            <div id="tasks-list" class="space-y-4">
                </div>
            <p id="no-tasks-msg" class="text-gray-400 mt-4 hidden">No tasks available right now. Check back later!</p>
        </div>

        <div id="withdraw-page" class="page">
            <h2 class="text-2xl font-bold mb-4">Withdrawal Request</h2>
            <div class="glass-card">
                <div class="mb-4">
                    <label for="withdraw-amount" class="block mb-2 font-semibold">Amount (Coins)</label>
                    <input type="number" id="withdraw-amount" placeholder="Min 1000 Coins" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="upi-id" class="block mb-2 font-semibold">UPI ID</label>
                    <input type="text" id="upi-id" placeholder="yourname@bankupi" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button id="request-withdraw-btn" onclick="requestWithdrawal()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition-all duration-200">
                    üí∏ Request Withdrawal
                </button>
            </div>

            <h3 class="text-xl font-bold mt-8 mb-4">Withdrawal History</h3>
            <div id="withdrawal-history-list" class="space-y-3">
                <p class="text-gray-400 text-sm">Loading history...</p>
            </div>
        </div>

        <div id="profile-page" class="page">
            <h2 class="text-2xl font-bold mb-4">Your Profile</h2>
            <div id="profile-details" class="space-y-3 glass-card">
                </div>

            <h3 class="text-xl font-bold mt-8 mb-4">Refer & Earn (500 Coins!)</h3>
            <div class="glass-card p-4">
                <p class="mb-3">Share your unique link to invite friends. You both get **500 Coins**!</p>
                <input type="text" id="referral-link" readonly class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-sm mb-3">
                <button onclick="copyReferralLink()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-xl transition-all duration-200">
                    üîó Copy Link
                </button>
            </div>

            <h3 class="text-xl font-bold mt-8 mb-4">Referral History</h3>
            <div id="referral-history-list" class="space-y-3">
                <p class="text-gray-400 text-sm">Loading referrals...</p>
            </div>
        </div>

        <div id="admin-dashboard-page" class="page active">
            <h2 class="text-2xl font-bold mb-4">Admin Dashboard üëë</h2>
            <div id="admin-dashboard-cards" class="grid grid-cols-2 gap-4 mb-6">
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-green-400" id="total-users-admin">0</div>
                    <div class="text-sm mt-1 text-gray-300">Total Users</div>
                </div>
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-red-400" id="total-tasks-admin">0</div>
                    <div class="text-sm mt-1 text-gray-300">Total Tasks</div>
                </div>
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-yellow-400" id="total-withdrawals-admin">0</div>
                    <div class="text-sm mt-1 text-gray-300">Total Withdrawals</div>
                </div>
                <div class="glass-card flex flex-col items-center justify-center text-center p-3">
                    <div class="text-3xl font-bold text-blue-400" id="total-ads-admin">0</div>
                    <div class="text-sm mt-1 text-gray-300">Total Ads Watched</div>
                </div>
            </div>

            <h3 class="text-xl font-semibold mb-3">Admin Quick Tools</h3>
            <div class="space-y-4">
                <button onclick="navigateTo('admin-task-management-page')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                    ‚ûï Manage Tasks
                </button>
                <button onclick="navigateTo('admin-withdrawal-management-page')" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                    üè¶ Manage Withdrawals
                </button>
                <button onclick="navigateTo('admin-tools-page')" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                    ‚öôÔ∏è Admin Tools
                </button>
            </div>
        </div>

        <div id="admin-task-management-page" class="page">
            <h2 class="text-2xl font-bold mb-4">Task Management</h2>

            <div class="glass-card mb-6 p-4">
                <h3 class="text-xl font-semibold mb-3">‚ûï Add New Task</h3>
                <input type="text" id="task-title" placeholder="Title" class="w-full p-3 mb-3 bg-gray-800 border border-gray-700 rounded-lg">
                <textarea id="task-description" placeholder="Description" rows="2" class="w-full p-3 mb-3 bg-gray-800 border border-gray-700 rounded-lg"></textarea>
                <input type="number" id="task-reward" placeholder="Reward (Coins)" class="w-full p-3 mb-3 bg-gray-800 border border-gray-700 rounded-lg">
                <input type="url" id="task-link" placeholder="Visit Link (e.g., https://example.com)" class="w-full p-3 mb-4 bg-gray-800 border border-gray-700 rounded-lg">
                <button onclick="addNewTask()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-xl transition-all duration-200">
                    Publish Task
                </button>
            </div>

            <h3 class="text-xl font-bold mb-4">Current Tasks</h3>
            <div id="admin-tasks-list" class="space-y-4">
                </div>
        </div>

        <div id="admin-withdrawal-management-page" class="page">
            <h2 class="text-2xl font-bold mb-4">Withdrawal Requests</h2>
            <div id="withdrawal-requests-list" class="space-y-4">
                <p class="text-gray-400 text-sm">Loading requests...</p>
            </div>
        </div>

        <div id="admin-tools-page" class="page">
            <h2 class="text-2xl font-bold mb-4">Admin Tools</h2>

            <div class="glass-card mb-6 p-4">
                <h3 class="text-xl font-semibold mb-3">Manual Balance Adjust</h3>
                <input type="number" id="manual-user-id" placeholder="User Telegram ID" class="w-full p-3 mb-3 bg-gray-800 border border-gray-700 rounded-lg">
                <input type="number" id="manual-amount" placeholder="Amount to Add/Subtract (+/-)" class="w-full p-3 mb-3 bg-gray-800 border border-gray-700 rounded-lg">
                <button onclick="adjustUserBalance()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-xl transition-all duration-200">
                    Apply Adjustment
                </button>
            </div>

            <div class="glass-card p-4">
                <h3 class="text-xl font-semibold mb-3">Broadcast Message</h3>
                <textarea id="broadcast-message" placeholder="Message to send to all users (Optional)" rows="3" class="w-full p-3 mb-3 bg-gray-800 border border-gray-700 rounded-lg"></textarea>
                <button onclick="sendBroadcast()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-xl transition-all duration-200">
                    Send Broadcast
                </button>
                <p class="text-xs text-gray-400 mt-2">Note: This is a placeholder function; actual Telegram message broadcast requires a separate bot API server.</p>
            </div>
        </div>

        <div id="system-popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[200] hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center" style="color: var(--tg-theme-text-color, #000);">
                <h3 id="popup-title" class="text-xl font-bold mb-3">Notification</h3>
                <p id="popup-message" class="mb-4">Message content.</p>
                <button onclick="hidePopup()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200">
                    OK
                </button>
            </div>
        </div>

    </main>

    <footer id="bottom-nav" class="bottom-nav flex justify-around items-center px-2">
        </footer>

    <script>
        // === 1. CONFIGURATION & INITIALIZATION ===

        // TODO: Replace with your actual Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        const urlParams = new URLSearchParams(window.location.search);
        const isUserMode = urlParams.get('user') === 'true';
        const isAdminMode = urlParams.get('admin') === 'true';
        let currentUser = null;
        let telegramUser = window.Telegram.WebApp.initDataUnsafe.user || {
            id: 123456789, // Placeholder for testing outside Telegram
            first_name: "Test",
            username: "tester"
        };
        const REFERRAL_REWARD = 500; // Coins per referral

        // === 2. UI UTILITY FUNCTIONS ===

        /**
         * Shows a notification popup to the user.
         * @param {string} title
         * @param {string} message
         */
        function showPopup(title, message) {
            document.getElementById('popup-title').innerText = title;
            document.getElementById('popup-message').innerText = message;
            document.getElementById('system-popup').classList.remove('hidden');
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

        function hidePopup() {
            document.getElementById('system-popup').classList.add('hidden');
        }

        /**
         * Handles page navigation and transition.
         * @param {string} pageId The ID of the page to navigate to (e.g., 'user-home-page').
         */
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            // Update active state on bottom navigation
            document.querySelectorAll('.bottom-nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            const navButton = document.querySelector(`[onclick*="${pageId}"]`);
            if (navButton) {
                navButton.classList.add('active');
            }

            // Update app title
            const titleMap = {
                'user-home-page': 'Dashboard',
                'watch-ads-page': 'Watch Ads',
                'tasks-page': 'Tasks',
                'withdraw-page': 'Withdraw',
                'profile-page': 'Profile',
                'admin-dashboard-page': 'Admin Dashboard',
                'admin-task-management-page': 'Manage Tasks',
                'admin-withdrawal-management-page': 'Manage Withdrawals',
                'admin-tools-page': 'Admin Tools'
            };
            document.getElementById('app-title').innerText = titleMap[pageId] || 'CoinEarn App';

            // Show balance only in user mode
            document.getElementById('user-balance-display').classList.toggle('hidden', !isUserMode);
        }

         /**
         * Builds the bottom navigation bar based on the mode.
         */
        function setupBottomNav() {
            const nav = document.getElementById('bottom-nav');
            nav.innerHTML = ''; // Clear existing buttons

            if (isUserMode) {
                const userNavItems = [
                    { id: 'user-home-page', icon: 'üè†', label: 'Home' },
                    { id: 'tasks-page', icon: '‚úÖ', label: 'Tasks' },
                    { id: 'withdraw-page', icon: 'üè¶', label: 'Withdraw' },
                    { id: 'profile-page', icon: 'üë§', label: 'Profile' }
                ];

                userNavItems.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'flex flex-col items-center justify-center p-2 text-xs h-full transition-all duration-200';
                    btn.setAttribute('onclick', `MapsTo('${item.id}')`);
                    btn.innerHTML = `<span>${item.icon}</span> ${item.label}`;
                    nav.appendChild(btn);
                });
                navigateTo('user-home-page'); // Default page
            } else if (isAdminMode) {
                const adminNavItems = [
                    { id: 'admin-dashboard-page', icon: 'üëë', label: 'Dashboard' },
                    { id: 'admin-task-management-page', icon: 'üìù', label: 'Tasks' },
                    { id: 'admin-withdrawal-management-page', icon: 'üí∏', label: 'Withdrawals' },
                    { id: 'admin-tools-page', icon: '‚öôÔ∏è', label: 'Settings' }
                ];

                adminNavItems.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'flex flex-col items-center justify-center p-2 text-xs h-full transition-all duration-200';
                    btn.setAttribute('onclick', `MapsTo('${item.id}')`);
                    btn.innerHTML = `<span>${item.icon}</span> ${item.label}`;
                    nav.appendChild(btn);
                });
                navigateTo('admin-dashboard-page'); // Default page
            } else {
                // If no valid mode, show an error
                document.getElementById('app-title').innerText = 'Error';
                document.getElementById('app-content').innerHTML = '<p class="text-center text-red-500 mt-12">Invalid URL parameter. Use `?user=true` or `?admin=true`.</p>';
                nav.classList.add('hidden');
            }
        }

        // === 3. FIREBASE USER & REAL-TIME LOGIC ===

        /**
         * Initializes user session and real-time listeners.
         */
        async function initializeApp() {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();

            if (isUserMode) {
                await setupUserSession();
                setupUserListeners();
                fetchAndDisplayUserReferralHistory();
            } else if (isAdminMode) {
                setupAdminListeners();
            }

            setupBottomNav();
        }

        /**
         * Sets up the user's document in Firestore (if it doesn't exist)
         * and processes any referral.
         */
        async function setupUserSession() {
            const userId = telegramUser.id.toString();
            const userRef = db.collection('users').doc(userId);
            const userDoc = await userRef.get();

            if (!userDoc.exists) {
                // Check for referral in URL
                const referrerId = urlParams.get('ref');
                const initialData = {
                    id: userId,
                    username: telegramUser.username || '',
                    firstName: telegramUser.first_name || 'User',
                    balance: 0,
                    totalEarn: 0,
                    totalWithdrawal: 0,
                    adsWatched: 0,
                    tasksDone: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    referrerId: referrerId || null
                };
                await userRef.set(initialData);

                // Handle referral reward
                if (referrerId && referrerId !== userId) {
                    const referrerRef = db.collection('users').doc(referrerId);
                    const referrerDoc = await referrerRef.get();

                    if (referrerDoc.exists) {
                        // Give reward to the new user
                        await userRef.update({
                            balance: REFERRAL_REWARD,
                            totalEarn: REFERRAL_REWARD
                        });
                        showPopup("Welcome Bonus!", `You earned ${REFERRAL_REWARD} Coins for joining!`);

                        // Give reward to the referrer and log the referral
                        await referrerRef.update({
                            balance: firebase.firestore.FieldValue.increment(REFERRAL_REWARD),
                            totalEarn: firebase.firestore.FieldValue.increment(REFERRAL_REWARD),
                        });
                        await db.collection('referrals').add({
                            referrerId: referrerId,
                            referredId: userId,
                            referredUsername: telegramUser.username || 'New User',
                            reward: REFERRAL_REWARD,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showPopup("Referral Reward!", `Your referrer (${referrerDoc.data().username || referrerDoc.data().firstName}) has been rewarded!`);
                    }
                }
            }

            // Set up referral link for the profile page
            const referralLink = `${window.location.origin}${window.location.pathname}?user=true&ref=${userId}`;
            document.getElementById('referral-link').value = referralLink;
        }

        /**
         * Sets up all real-time Firestore listeners for the User Panel.
         */
        function setupUserListeners() {
            const userId = telegramUser.id.toString();

            // 1. User Data Listener (Dashboard & Profile)
            db.collection('users').doc(userId).onSnapshot(doc => {
                if (doc.exists) {
                    currentUser = doc.data();
                    updateUserDashboard(currentUser);
                    updateUserProfile(currentUser);
                    fetchAndDisplayUserWithdrawalHistory(userId); // Re-fetch on data change
                }
            });

            // 2. Tasks Listener (Tasks Page)
            db.collection('tasks').onSnapshot(snapshot => {
                renderUserTasks(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });

            // 3. Withdrawal History is fetched inside the user data listener to ensure up-to-date balance.
        }

        /**
         * Sets up all real-time Firestore listeners for the Admin Panel.
         */
        function setupAdminListeners() {
            // 1. Dashboard Metrics
            db.collection('users').onSnapshot(usersSnapshot => {
                let totalUsers = usersSnapshot.size;
                let totalAdsWatched = 0;
                let totalWithdrawals = 0;

                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    totalAdsWatched += userData.adsWatched || 0;
                    totalWithdrawals += userData.totalWithdrawal || 0; // Assuming totalWithdrawal tracks the cumulative amount
                });

                document.getElementById('total-users-admin').innerText = totalUsers.toLocaleString();
                document.getElementById('total-ads-admin').innerText = totalAdsWatched.toLocaleString();
                document.getElementById('total-withdrawals-admin').innerText = totalWithdrawals.toLocaleString();
            });

            db.collection('tasks').onSnapshot(tasksSnapshot => {
                document.getElementById('total-tasks-admin').innerText = tasksSnapshot.size.toLocaleString();
                renderAdminTasks(tasksSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });

            // 2. Withdrawal Requests Listener
            db.collection('withdrawals').where('status', '==', 'Pending').onSnapshot(snapshot => {
                renderAdminWithdrawalRequests(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });
        }

        // === 4. USER PANEL FUNCTIONS ===

        /**
         * Updates all dashboard cards and the top bar balance.
         * @param {object} user - The current user data object.
         */
        function updateUserDashboard(user) {
            document.getElementById('user-balance').innerText = user.balance.toLocaleString();
            document.getElementById('total-earn').innerText = user.totalEarn.toLocaleString();
            document.getElementById('total-withdrawal').innerText = user.totalWithdrawal.toLocaleString();
            document.getElementById('ads-watched').innerText = user.adsWatched.toLocaleString();
            document.getElementById('total-tasks-done').innerText = user.tasksDone.toLocaleString();
        }

        /**
         * Updates the profile page details.
         * @param {object} user - The current user data object.
         */
        function updateUserProfile(user) {
            const details = document.getElementById('profile-details');
            details.innerHTML = `
                <p><strong>Username:</strong> @${user.username || 'N/A'}</p>
                <p><strong>Name:</strong> ${user.firstName}</p>
                <p><strong>User ID:</strong> <code>${user.id}</code></p>
                <p><strong>Total Earn:</strong> <span class="text-green-400 font-bold">${user.totalEarn.toLocaleString()} üí∞</span></p>
                <p><strong>Total Withdraw:</strong> <span class="text-red-400 font-bold">${user.totalWithdrawal.toLocaleString()} üè¶</span></p>
            `;
        }

        /**
         * Starts the 'Watch Ad' sequence.
         */
        async function startAdSequence() {
            const WATCH_REWARD = 10;
            const btn = document.getElementById('watch-ad-btn');

            // 1. Disable button and simulate ad play/load (Monotag Placeholder)
            btn.disabled = true;
            btn.innerHTML = 'üîÑ Loading Ad... (Wait 5s)';
            window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');

            await new Promise(resolve => setTimeout(resolve, 5000)); // Simulate ad loading time

            // 2. Reward the user
            const userId = telegramUser.id.toString();
            const userRef = db.collection('users').doc(userId);

            try {
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User does not exist!";
                    const user = userDoc.data();

                    transaction.update(userRef, {
                        balance: user.balance + WATCH_REWARD,
                        totalEarn: user.totalEarn + WATCH_REWARD,
                        adsWatched: user.adsWatched + 1
                    });
                });

                showPopup("Success!", `You earned ${WATCH_REWARD} Coins! Your new balance is ${currentUser.balance + WATCH_REWARD} üí∞`);
            } catch (e) {
                console.error("Ad reward transaction failed: ", e);
                showPopup("Error", "Could not process reward. Please try again.");
            } finally {
                // 3. Re-enable button
                btn.disabled = false;
                btn.innerHTML = '‚ñ∂Ô∏è Watch Ad Now';
            }
        }

        /**
         * Renders the list of available tasks for the user.
         * @param {Array<object>} tasks - Array of task objects from Firestore.
         */
        function renderUserTasks(tasks) {
            const list = document.getElementById('tasks-list');
            list.innerHTML = '';

            if (tasks.length === 0) {
                document.getElementById('no-tasks-msg').classList.remove('hidden');
                return;
            }
            document.getElementById('no-tasks-msg').classList.add('hidden');

            tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = 'glass-card flex justify-between items-center transition-transform hover:scale-[1.01]';
                taskCard.innerHTML = `
                    <div>
                        <h4 class="text-lg font-bold">${task.title}</h4>
                        <p class="text-sm text-gray-400 mb-2">${task.description}</p>
                        <p class="text-yellow-400 font-semibold">Reward: ${task.reward.toLocaleString()} üí∞</p>
                    </div>
                    <button id="task-btn-${task.id}" onclick="startTaskTimer('${task.id}', '${task.link}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all duration-200">
                        Visit
                    </button>
                `;
                list.appendChild(taskCard);
            });
        }

        /**
         * Starts the 10-second timer/animation for a task.
         * @param {string} taskId - The ID of the task.
         * @param {string} link - The external link to visit.
         */
        async function startTaskTimer(taskId, link) {
            const btn = document.getElementById(`task-btn-${taskId}`);
            const originalText = btn.innerText;
            const timerDuration = 10; // 10 seconds

            // 1. Open the external link
            window.open(link, '_blank');

            // 2. Start Timer/Loading
            btn.disabled = true;
            for (let i = timerDuration; i > 0; i--) {
                btn.innerHTML = `‚è≥ ${i}s Left`;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            // 3. Change to Claim Reward
            btn.innerHTML = 'üéâ Claim Reward';
            btn.onclick = () => claimTaskReward(taskId);
            btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            btn.classList.add('bg-green-600', 'hover:bg-green-700');
            btn.disabled = false;

            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            showPopup("Claim Ready!", "The 10-second timer is up. Click 'Claim Reward' to get your coins!");
        }

        /**
         * Finalizes the task and adds the reward to the user's balance.
         * @param {string} taskId - The ID of the task to claim.
         */
        async function claimTaskReward(taskId) {
            const userId = telegramUser.id.toString();
            const taskRef = db.collection('tasks').doc(taskId);
            const userRef = db.collection('users').doc(userId);
            const btn = document.getElementById(`task-btn-${taskId}`);

            try {
                // Fetch the task data to get the reward amount
                const taskDoc = await taskRef.get();
                if (!taskDoc.exists) {
                    showPopup("Error", "Task not found!");
                    return;
                }
                const reward = taskDoc.data().reward;
                const taskTitle = taskDoc.data().title;

                btn.disabled = true;
                btn.innerHTML = '...Claiming...';

                // Transaction to ensure atomicity
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw "User does not exist!";
                    const user = userDoc.data();

                    // Update user balance and stats
                    transaction.update(userRef, {
                        balance: user.balance + reward,
                        totalEarn: user.totalEarn + reward,
                        tasksDone: user.tasksDone + 1
                    });

                    // Store reward history for the user
                    await db.collection('rewards_history').add({
                        userId: userId,
                        taskId: taskId,
                        taskTitle: taskTitle,
                        reward: reward,
                        type: 'Task',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                showPopup("Reward Claimed!", `You successfully claimed **${reward} Coins** for: **${taskTitle}**!`);
                // Disable button permanently after claim (user cannot do the same task twice in this simple model)
                btn.innerHTML = '‚úÖ Done!';
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-gray-500');
                btn.onclick = null;

            } catch (e) {
                console.error("Task claim transaction failed: ", e);
                showPopup("Error", "Could not claim reward. Please check if you already completed this task or try again.");
                // Reset button on failure
                btn.disabled = false;
                btn.innerHTML = 'Visit';
                btn.onclick = () => startTaskTimer(taskId, taskDoc.data().link);
                btn.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-gray-500');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
        }

        /**
         * Submits a withdrawal request to Firebase.
         */
        async function requestWithdrawal() {
            const amountInput = document.getElementById('withdraw-amount');
            const upiIdInput = document.getElementById('upi-id');
            const amount = parseInt(amountInput.value);
            const upiId = upiIdInput.value.trim();
            const btn = document.getElementById('request-withdraw-btn');

            if (!amount || amount < 100) {
                showPopup("Error", "Please enter a valid amount (Min 100 coins).");
                return;
            }
            if (!upiId) {
                showPopup("Error", "Please enter your UPI ID.");
                return;
            }
            if (amount > currentUser.balance) {
                showPopup("Error", `Insufficient balance. You have ${currentUser.balance} coins.`);
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '...Requesting...';

            try {
                // Transaction to deduct balance and record withdrawal
                await db.runTransaction(async (transaction) => {
                    const userRef = db.collection('users').doc(telegramUser.id.toString());
                    const userDoc = await transaction.get(userRef);
                    const user = userDoc.data();

                    if (user.balance < amount) {
                        throw new Error("Balance check failed during transaction.");
                    }

                    // 1. Deduct balance immediately
                    transaction.update(userRef, {
                        balance: user.balance - amount
                    });

                     // 2. Add withdrawal request
                    await db.collection('withdrawals').add({
                        userId: telegramUser.id.toString(),
                        username: telegramUser.username || 'N/A',
                        firstName: telegramUser.first_name || 'User',
                        amount: amount,
                        upiId: upiId,
                        status: 'Pending', // Pending | Accepted | Rejected
                        requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });

                showPopup("Request Sent!", `Withdrawal of **${amount} Coins** to UPI ID **${upiId}** is pending.`);
                amountInput.value = '';
                upiIdInput.value = '';

            } catch (e) {
                console.error("Withdrawal transaction failed: ", e);
                showPopup("Error", "Failed to submit withdrawal request: " + e.message);

            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üí∏ Request Withdrawal';
            }
        }

        /**
         * Fetches and displays the user's withdrawal history.
         * @param {string} userId - The current user's Telegram ID.
         */
        function fetchAndDisplayUserWithdrawalHistory(userId) {
            const list = document.getElementById('withdrawal-history-list');
            list.innerHTML = '<p class="text-gray-400 text-sm">Loading history...</p>';

            db.collection('withdrawals').where('userId', '==', userId).orderBy('requestedAt', 'desc')
                .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        list.innerHTML = '<p class="text-gray-400 text-sm">No withdrawal history found.</p>';
                        return;
                    }

                    list.innerHTML = '';
                    snapshot.forEach(doc => {
                        const item = doc.data();
                        let statusColor = '';
                        let statusIcon = '';

                        if (item.status === 'Accepted') {
                            statusColor = 'bg-green-600';
                            statusIcon = '‚úÖ';
                        } else if (item.status === 'Rejected') {
                            statusColor = 'bg-red-600';
                            statusIcon = '‚ùå';
                        } else {
                            statusColor = 'bg-yellow-600';
                            statusIcon = '‚è≥';
                        }

                        const dateStr = item.requestedAt ? new Date(item.requestedAt.toDate()).toLocaleDateString() : 'N/A';

                        const listItem = document.createElement('div');
                        listItem.className = 'glass-card flex justify-between items-center p-3 text-sm';
                        listItem.innerHTML = `
                            <div>
                                <p class="font-bold">Amount: ${item.amount.toLocaleString()} üí∞</p>
                                <p class="text-xs text-gray-400">UPI: ${item.upiId}</p>
                            </div>
                            <div class="${statusColor} text-white px-2 py-1 rounded-full text-xs font-semibold">
                                ${statusIcon} ${item.status}
                            </div>
                        `;
                        list.appendChild(listItem);

                        // Real-time notification for status change
                        if (doc.metadata.hasPendingWrites === false && item.status !== 'Pending' && currentUser.lastWithdrawalStatus !== item.status) {
                            showPopup("Withdrawal Update!", `Your request of ${item.amount} Coins has been **${item.status}**!`);
                            // Small hack to prevent repeated notifications on every snapshot.
                            // In a real app, you'd track a "last_notified_status" field in the user doc.
                            currentUser.lastWithdrawalStatus = item.status;
                        }
                    });
                });
        }

        /**
         * Fetches and displays the user's referral history.
         */
        function fetchAndDisplayUserReferralHistory() {
            const list = document.getElementById('referral-history-list');
            const userId = telegramUser.id.toString();
            list.innerHTML = '<p class="text-gray-400 text-sm">Loading referrals...</p>';

            db.collection('referrals').where('referrerId', '==', userId).orderBy('timestamp', 'desc')
                .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        list.innerHTML = '<p class="text-gray-400 text-sm">You haven\'t referred anyone yet.</p>';
                        return;
                    }

                    list.innerHTML = '';
                    snapshot.forEach(doc => {
                        const item = doc.data();
                        const listItem = document.createElement('div');
                        listItem.className = 'glass-card flex justify-between items-center p-3 text-sm';
                        listItem.innerHTML = `
                            <div>
                                <p class="font-bold">Referred: ${item.referredUsername || 'User'}</p>
                                <p class="text-xs text-gray-400">ID: ${item.referredId}</p>
                            </div>
                            <div class="bg-purple-600 text-white px-2 py-1 rounded-full text-xs font-semibold">
                                +${item.reward.toLocaleString()} üí∞
                            </div>
                        `;
                        list.appendChild(listItem);
                    });
                });
        }

        /**
         * Copies the referral link to the clipboard.
         */
        function copyReferralLink() {
            const linkInput = document.getElementById('referral-link');
            linkInput.select();
            document.execCommand('copy');
            showPopup("Copied!", "Your referral link has been copied to your clipboard.");
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }


        // === 5. ADMIN PANEL FUNCTIONS ===

        /**
         * Renders the list of tasks for admin management.
         * @param {Array<object>} tasks - Array of task objects from Firestore.
         */
        function renderAdminTasks(tasks) {
            const list = document.getElementById('admin-tasks-list');
            list.innerHTML = '';

            if (tasks.length === 0) {
                list.innerHTML = '<p class="text-gray-400 mt-4">No tasks in database.</p>';
                return;
            }

            tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.id = `admin-task-${task.id}`;
                taskCard.className = 'glass-card border-l-4 border-indigo-500 p-4';
                taskCard.innerHTML = `
                    <h4 class="text-lg font-bold">${task.title}</h4>
                    <p class="text-sm text-gray-400 mb-2">${task.description}</p>
                    <p class="text-yellow-400 font-semibold">Reward: ${task.reward.toLocaleString()} üí∞ | Link: <a href="${task.link}" target="_blank" class="text-blue-400 hover:text-blue-300">View</a></p>
                    <div class="mt-3 flex space-x-2">
                        <button onclick="deleteTask('${task.id}')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-xs transition-all duration-200">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                `;
                list.appendChild(taskCard);
            });
        }

        /**
         * Adds a new task to Firebase.
         */
        async function addNewTask() {
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const reward = parseInt(document.getElementById('task-reward').value);
            const link = document.getElementById('task-link').value.trim();

            if (!title || !description || !reward || !link || reward <= 0) {
                showPopup("Error", "Please fill all fields with valid data.");
                return;
            }

            try {
                await db.collection('tasks').add({
                    title: title,
                    description: description,
                    reward: reward,
                    link: link,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showPopup("Success", `Task "**${title}**" published instantly!`);
                // Clear form
                document.getElementById('task-title').value = '';
                document.getElementById('task-description').value = '';
                document.getElementById('task-reward').value = '';
                document.getElementById('task-link').value = '';

            } catch (e) {
                console.error("Error adding task: ", e);
                showPopup("Error", "Failed to add task.");
            }
        }

        /**
         * Deletes a task from Firebase.
         * @param {string} taskId - The ID of the task to delete.
         */
        async function deleteTask(taskId) {
            if (!confirm("Are you sure you want to delete this task?")) return;

            try {
                await db.collection('tasks').doc(taskId).delete();
                showPopup("Success", "Task deleted instantly!");
            } catch (e) {
                console.error("Error deleting task: ", e);
                showPopup("Error", "Failed to delete task.");
            }
        }

        /**
         * Renders the list of pending withdrawal requests for the admin.
         * @param {Array<object>} requests - Array of withdrawal request objects.
         */
        function renderAdminWithdrawalRequests(requests) {
            const list = document.getElementById('withdrawal-requests-list');
            list.innerHTML = '';

            if (requests.length === 0) {
                list.innerHTML = '<p class="text-gray-400 mt-4">No pending withdrawal requests.</p>';
                return;
            }

            requests.forEach(req => {
                const requestCard = document.createElement('div');
                requestCard.className = 'glass-card border-l-4 border-yellow-500 p-4';
                requestCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-lg">${req.amount.toLocaleString()} üí∞ - ${req.firstName}</p>
                            <p class="text-sm text-gray-400">@${req.username || 'N/A'} (ID: ${req.userId})</p>
                            <p class="text-sm font-mono text-yellow-300 mt-1">UPI: ${req.upiId}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="updateWithdrawalStatus('${req.id}', 'Accepted', ${req.amount}, '${req.userId}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg text-sm transition-all duration-200">
                                ‚úÖ Accept
                            </button>
                            <button onclick="updateWithdrawalStatus('${req.id}', 'Rejected', ${req.amount}, '${req.userId}')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-sm transition-all duration-200">
                                ‚ùå Reject
                            </button>
                        </div>
                    </div>
                `;
                list.appendChild(requestCard);
            });
        }

        /**
         * Updates the status of a withdrawal request.
         * @param {string} requestId - ID of the withdrawal document.
         * @param {string} status - New status ('Accepted' or 'Rejected').
         * @param {number} amount - The withdrawal amount.
         * @param {string} userId - The user's ID.
         */
        async function updateWithdrawalStatus(requestId, status, amount, userId) {
            try {
                const requestRef = db.collection('withdrawals').doc(requestId);
                const userRef = db.collection('users').doc(userId);

                await db.runTransaction(async (transaction) => {
                    // 1. Update the withdrawal request status
                    transaction.update(requestRef, {
                        status: status,
                        processedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        processedBy: telegramUser.id.toString()
                    });

                    // 2. Handle rejection (return coins to user)
                    if (status === 'Rejected') {
                        const userDoc = await transaction.get(userRef);
                        const user = userDoc.data();
                        transaction.update(userRef, {
                            balance: user.balance + amount
                        });
                    }

                    // 3. Handle acceptance (update total withdrawal stats)
                    if (status === 'Accepted') {
                         const userDoc = await transaction.get(userRef);
                        const user = userDoc.data();
                        transaction.update(userRef, {
                            totalWithdrawal: user.totalWithdrawal + amount
                        });
                    }
                });

                showPopup("Status Updated", `Withdrawal request **${requestId.substring(0, 4)}...** set to **${status}**.`);

            } catch (e) {
                console.error(`Error updating withdrawal status to ${status}: `, e);
                showPopup("Error", `Failed to set withdrawal status to ${status}.`);
            }
        }

        /**
         * Manually adjusts a user's coin balance.
         */
        async function adjustUserBalance() {
            const userId = document.getElementById('manual-user-id').value.trim();
            const amount = parseInt(document.getElementById('manual-amount').value);

            if (!userId || !amount) {
                showPopup("Error", "Please enter a User ID and an amount.");
                return;
            }

            try {
                const userRef = db.collection('users').doc(userId);
                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) throw new Error("User not found!");

                    const user = userDoc.data();
                    const newBalance = user.balance + amount;

                    transaction.update(userRef, {
                        balance: newBalance,
                        totalEarn: user.totalEarn + (amount > 0 ? amount : 0) // Only count positive adjustments in totalEarn
                    });
                });

                showPopup("Success", `Balance for User ID **${userId}** adjusted by **${amount} Coins**.`);
                document.getElementById('manual-user-id').value = '';
                document.getElementById('manual-amount').value = '';
            } catch (e) {
                console.error("Balance adjustment failed: ", e);
                showPopup("Error", "Failed to adjust balance: " + e.message);
            }
        }

        /**
         * Placeholder for sending a broadcast message (requires external bot API).
         */
        function sendBroadcast() {
            const message = document.getElementById('broadcast-message').value.trim();
            if (!message) {
                showPopup("Note", "Broadcast message is empty.");
                return;
            }
            // In a real application, this function would call an external API endpoint
            // (on your server) which uses the Telegram Bot API to send a message to all users.
            showPopup("Broadcast Placeholder", `Broadcast message: "**${message.substring(0, 30)}...**" has been logged. Actual sending requires a backend server.`);
            document.getElementById('broadcast-message').value = '';
        }

        // === 6. APPLICATION STARTUP ===
        window.onload = initializeApp;

    </script>
</body>
</html>